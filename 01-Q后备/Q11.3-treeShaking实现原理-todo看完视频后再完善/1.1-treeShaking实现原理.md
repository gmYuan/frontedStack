## å¸¸è§é…ç½®åŸç†

Q1.1 å®ç° tree shaking éœ€è¦å…ˆäº†è§£ å“ªäº›å‰ç½®çŸ¥è¯†

A: <br/>

1 å‰ç½®çŸ¥è¯†1ï¼šç¼–è¯‘æ—¶ VS è¿è¡Œæ—¶
  - ç¼–è¯‘æ—¶ï¼š åœ¨æ‰“åŒ…æ„å»ºé˜¶æ®µï¼Œ å¯¹ä»£ç è¿›è¡Œåˆ†æã€è½¬æ¢ã€ä¼˜åŒ–ç­‰æ“ä½œ
  - è¿è¡Œæ—¶ï¼š åœ¨å®¿ä¸»ç¯å¢ƒ æ‰§è¡Œä»£ç æ—¶


2 å‰ç½®çŸ¥è¯†2ï¼šä¸ºä»€ä¹ˆéESMè§„èŒƒçš„å¯¼å…¥å¯¼å‡ºï¼Œå°±æ— æ³•é™æ€åˆ†æï¼Œå¯¼è‡´æ— æ³•å®ç°tree shaking

2.1 ESM (ES Module) å’Œå…¶ä»–æ¨¡å—è§„èŒƒ(å¦‚ CommonJS)çš„æ ¹æœ¬åŒºåˆ«åœ¨äº `å¯¼å…¥å¯¼å‡ºå˜é‡å€¼åœ¨ç¼–è¯‘æ—¶ æ˜¯å¦æ˜¯ç¡®å®šçš„`

2.2 CommonJS vs ESM ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ç»´åº¦ | CommonJS | ES Modules |
|---------|----------|------------|
| **å¯¼å…¥è¯­æ³•** | `require()` | `import` |
| **å¯¼å‡ºè¯­æ³•** | `module.exports`, `exports` | `export`, `export default` |
| **å¯¼å…¥ä½ç½®** | ä»»æ„ä½ç½® | åªèƒ½åœ¨é¡¶å±‚ä½œç”¨åŸŸ |
| **å¯¼å…¥è·¯å¾„** | æ”¯æŒåŠ¨æ€è·¯å¾„<br>`require(`./${path}`)` | åªèƒ½æ˜¯å­—ç¬¦ä¸²å­—é¢é‡<br>`import './foo'` |
| **å¯¼å‡ºå†…å®¹** | å¯ä»¥åŠ¨æ€è®¡ç®—<br>`exports.foo = compute()` | å¿…é¡»æ˜¯ç¡®å®šçš„å€¼æˆ–å¼•ç”¨ |
| **å¯¼å…¥å†…å®¹** | ğŸ”„ è¿è¡Œæ—¶ç¡®å®š | âš¡ ç¼–è¯‘æ—¶ç¡®å®š |
| **ä¾èµ–å…³ç³»** | ğŸ”„ è¿è¡Œæ—¶è§£æ | âš¡ ç¼–è¯‘æ—¶è§£æ |
| **åŠ è½½æ—¶æœº** | ğŸ”„ è¿è¡Œæ—¶åŠ è½½ | âš¡ ç¼–è¯‘æ—¶åŠ è½½ |
| **Tree Shaking** | éš¾ä»¥å®ç° | å¤©ç„¶æ”¯æŒ |


2.3 Tree Shaking éœ€è¦åœ¨ **ç¼–è¯‘æ—¶**ï¼š
  - ç¡®å®šæ¨¡å—é—´çš„ä¾èµ–å…³ç³»
  - åˆ†æå“ªäº›å¯¼å‡ºè¢«ä½¿ç”¨
  - åˆ é™¤æœªä½¿ç”¨çš„ä»£ç 

è€Œ CommonJS çš„ åŠ¨æ€ç‰¹æ€§ï¼Œå¯¼è‡´ åªæœ‰åœ¨çœŸæ­£è¿è¡Œæ—¶ï¼Œæ‰èƒ½çŸ¥é“å¯¼å…¥å¯¼å‡ºä¾èµ–çš„å˜é‡å€¼ï¼Œåˆ°åº•ä¼ å…¥çš„æ˜¯ä»€ä¹ˆ


2.4 åšä¸€ä¸ªç±»æ¯”çš„è¯
  - ESM è§„èŒƒï¼šæ˜¯ ä¸€ä¸ª "çº¯å‡½æ•°"ï¼Œä¸ä¾èµ–å¤–éƒ¨å˜é‡
  - CommonJS è§„èŒƒï¼šæ˜¯ ä¸€ä¸ª "å­˜åœ¨å‰¯ä½œç”¨çš„å‡½æ•°"ï¼Œä¾èµ–å¤–éƒ¨å˜é‡


-----------------------------------------------------------------
Q2.1 ä»å®è§‚ä¸Šä»‹ç»ï¼Œå®ç° tree shaking çš„å®è§‚æ€è·¯æ˜¯ä»€ä¹ˆ

A: <br/>

1 å…¶å¤§è‡´ å®ç°æ€è·¯æ˜¯ï¼š

S1 ä¾èµ–æ„å»º + åˆ†æ ESM è¯­å¥
  - è§£ææºç ç”Ÿæˆ AST
  - åˆ†æ ES Module çš„å¯¼å…¥å¯¼å‡º
  - æ„å»ºæ¨¡å—ä¾èµ–å›¾


S2 é€’å½’æ ‡è®°
  - ä»å…¥å£éå† ASTï¼Œæ ‡è®°ä½¿ç”¨åˆ°çš„å¯¼å‡ºï¼Œ æ”¶é›†æ¨¡å—å¯¼å‡ºä½¿ç”¨æƒ…å†µ
  - é€’å½’éå†ä¾èµ–å›¾ï¼ŒæŒç»­è¿›è¡Œæ ‡è®°
  - åˆ¤æ–­ä»£ç æ˜¯å¦æœ‰å‰¯ä½œç”¨ï¼Œé¿å…åˆ é™¤æœ‰å‰¯ä½œç”¨çš„ä»£ç 


S3 åˆ é™¤æœªä½¿ç”¨ä»£ç 
  - ç§»é™¤æœªä½¿ç”¨çš„å¯¼å‡º + ä»£ç å‹ç¼©ä¼˜åŒ–


```js
// å®ç°æ€è·¯çš„ä¼ªä»£ç 
class TreeShaker {
  constructor(entryModule) {
    this.dependencyGraph = new Map();
    this.usedExports = new Set();
    this.moduleParser = new ModuleParser(); // è§£æå™¨
    this.moduleCache = new Map(); // æ–°å¢: æ¨¡å—ç¼“å­˜ï¼Œé¿å…é‡å¤è§£æ
  }

  // æ”¶é›† ESMå¯¼å‡º + ç”Ÿæˆæ„å»ºä¾èµ–å›¾
  buildDependencyGraph(module) {
    // æ–°å¢: æ£€æŸ¥ç¼“å­˜
    if (this.moduleCache.has(module.id)) {
      return this.moduleCache.get(module.id);
    }

    // 1. è§£ææºç ç”Ÿæˆ AST
    const ast = this.moduleParser.parse(module.content);

    // 2. åˆ†ææ‰€æœ‰ ESMå¯¼å‡ºè¯­å¥ï¼Œç”Ÿæˆä¸º Dependencyå¯¹è±¡
    const dependencies = this.analyzeDependencies(ast);
    
    // æ–°å¢: åˆ†æå¯¼å‡ºè¯­å¥çš„ç±»å‹
    const exportTypes = this.analyzeExportTypes(ast);
    // exportTypes ç¤ºä¾‹:
    // {
    //   type: 'named' | 'default' | 'namespace',
    //   isReexport: boolean, // æ˜¯å¦æ˜¯é‡å¯¼å‡º
    //   source: string // é‡å¯¼å‡ºçš„æ¥æºæ¨¡å—
    // }

    // 3. æŠŠ Dependencyå¯¹è±¡ ç»Ÿä¸€è½¬åŒ–ä¸ºExportInfoå¯¹è±¡
    const exportInfo = this.createExportInfo(dependencies, exportTypes);
    
    // 4. å°†æ¨¡å—ä¿¡æ¯æ·»åŠ åˆ°ä¾èµ–å›¾ä¸­
    const moduleInfo = {
      ast,
      dependencies,
      exports: exportInfo,
      imports: this.analyzeImports(ast),
      hasSideEffects: this.checkSideEffects(ast),
      // æ–°å¢: è®°å½•æ¨¡å—çš„åŸºæœ¬ä¿¡æ¯
      meta: {
        id: module.id,
        path: module.path,
        type: this.getModuleType(module), // esm or cjs
        isEntry: module.isEntry || false
      }
    };

    // æ–°å¢: ç¼“å­˜æ¨¡å—ä¿¡æ¯
    this.moduleCache.set(module.id, moduleInfo);
    this.dependencyGraph.set(module.id, moduleInfo);

    // 5. é€’å½’å¤„ç†æ‰€æœ‰ä¾èµ–çš„æ¨¡å—
    for (const dep of dependencies) {
      if (!this.dependencyGraph.has(dep.module)) {
        const depModule = this.resolveModule(dep.module);
        // æ–°å¢: è®°å½•çˆ¶å­å…³ç³»
        depModule.parent = module.id;
        this.buildDependencyGraph(depModule);
      }
    }

    return moduleInfo;
  }

  // æ–°å¢: åˆ†æå¯¼å‡ºè¯­å¥çš„ç±»å‹
  analyzeExportTypes(ast) {
    // åˆ†æä¸åŒç±»å‹çš„å¯¼å‡º:
    // 1. export { foo }
    // 2. export default foo
    // 3. export * from './other'
    // 4. export { foo as bar } from './other'
    return [];
  }

  // æ–°å¢: è·å–æ¨¡å—ç±»å‹
  getModuleType(module) {
    // é€šè¿‡æ–‡ä»¶å†…å®¹æˆ–æ‰©å±•ååˆ¤æ–­æ˜¯ ESM è¿˜æ˜¯ CommonJS
    return 'esm';
  }

  // æ ‡è®°é˜¶æ®µ
  mark(startModule) {
    const moduleInfo = this.dependencyGraph.get(startModule.id);
    if (!moduleInfo) return;

    // åˆ›å»ºè®¿é—®è®°å½•ï¼Œé¿å…å¾ªç¯ä¾èµ–
    const visited = new Set();
    
    const markExports = (currentModule) => {
      if (visited.has(currentModule.id)) return;
      visited.add(currentModule.id);

      const info = this.dependencyGraph.get(currentModule.id);
      
      // å¤„ç†å¯¼å…¥è¯­å¥
      for (const imp of info.imports) {
        // å¯¹äºå…·åå¯¼å…¥ï¼Œæ ‡è®°ä½¿ç”¨çš„å¯¼å‡º
        if (imp.type === 'named') {
          const depModule = this.dependencyGraph.get(imp.source);
          if (depModule) {
            for (const name of imp.names) {
              const exportInfo = depModule.exports[name];
              if (exportInfo) {
                this.usedExports.add(`${depModule.meta.id}:${name}`);
              }
            }
            // é€’å½’å¤„ç†ä¾èµ–æ¨¡å—
            markExports({ id: imp.source });
          }
        }
        // å¯¹äºå‘½åç©ºé—´å¯¼å…¥ï¼Œæ ‡è®°æ‰€æœ‰å¯¼å‡º
        else if (imp.type === 'namespace') {
          const depModule = this.dependencyGraph.get(imp.source);
          if (depModule) {
            Object.keys(depModule.exports).forEach(name => {
              this.usedExports.add(`${depModule.meta.id}:${name}`);
            });
            markExports({ id: imp.source });
          }
        }
      }

      // å¤„ç†é‡å¯¼å‡º
      Object.values(info.exports).forEach(exp => {
        if (exp.isReexport && exp.source) {
          const depModule = this.dependencyGraph.get(exp.source);
          if (depModule) {
            markExports({ id: exp.source });
          }
        }
      });
    };

    markExports(startModule);
  }

  // åˆ é™¤é˜¶æ®µ
  shake() {
    const result = new Map();

    for (const [moduleId, moduleInfo] of this.dependencyGraph) {
      const newExports = {};
      let hasUsedExports = false;

      // åªä¿ç•™è¢«ä½¿ç”¨çš„å¯¼å‡º
      Object.entries(moduleInfo.exports).forEach(([name, exp]) => {
        const exportId = `${moduleId}:${name}`;
        if (this.usedExports.has(exportId) || moduleInfo.hasSideEffects) {
          newExports[name] = exp;
          hasUsedExports = true;
        }
      });

      // å¦‚æœæ¨¡å—æœ‰è¢«ä½¿ç”¨çš„å¯¼å‡ºæˆ–æœ‰å‰¯ä½œç”¨ï¼Œä¿ç•™è¯¥æ¨¡å—
      if (hasUsedExports || moduleInfo.hasSideEffects || moduleInfo.meta.isEntry) {
        result.set(moduleId, {
          ...moduleInfo,
          exports: newExports
        });
      }
    }

    return result;
  }

  // æ–°å¢: è§£æä¾èµ–
  analyzeDependencies(ast) {
    const dependencies = [];
    // éå† ASTï¼Œæ”¶é›†:
    // 1. import è¯­å¥çš„ä¾èµ–
    // 2. export from è¯­å¥çš„ä¾èµ–
    // 3. åŠ¨æ€ import() çš„ä¾èµ–
    return dependencies;
  }

  // æ–°å¢: åˆ†æå¯¼å…¥è¯­å¥
  analyzeImports(ast) {
    const imports = [];
    // éå† ASTï¼Œæ”¶é›† import è¯­å¥ä¿¡æ¯:
    // 1. é™æ€å¯¼å…¥ import { foo } from './foo'
    // 2. é»˜è®¤å¯¼å…¥ import default from './foo'
    // 3. å‘½åç©ºé—´å¯¼å…¥ import * as foo from './foo'
    // 4. å‰¯ä½œç”¨å¯¼å…¥ import './foo'
    return imports;
  }

  // æ–°å¢: åˆ›å»ºå¯¼å‡ºä¿¡æ¯
  createExportInfo(dependencies, exportTypes) {
    const exportInfo = {};
    // å¤„ç†ä¸åŒç±»å‹çš„å¯¼å‡º:
    // 1. æœ¬åœ°å¯¼å‡º export const foo = 1
    // 2. é‡å¯¼å‡º export { foo } from './foo'
    // 3. é»˜è®¤å¯¼å‡º export default foo
    // 4. å‘½åç©ºé—´é‡å¯¼å‡º export * from './foo'
    
    // è®°å½•æ¯ä¸ªå¯¼å‡ºçš„:
    // - åç§°
    // - æ¥æºæ¨¡å—
    // - æ˜¯å¦è¢«ä½¿ç”¨
    // - æ˜¯å¦æœ‰å‰¯ä½œç”¨
    return exportInfo;
  }

  // æ–°å¢: æ£€æŸ¥æ¨¡å—å‰¯ä½œç”¨
  checkSideEffects(ast) {
    // æ£€æŸ¥æ¨¡å—ä¸­çš„å‰¯ä½œç”¨:
    // 1. å…¨å±€å˜é‡çš„ä¿®æ”¹
    // 2. DOM æ“ä½œ
    // 3. ç½‘ç»œè¯·æ±‚
    // 4. åŸå‹é“¾ä¿®æ”¹
    // 5. äº‹ä»¶ç›‘å¬
    // 6. è®¡æ—¶å™¨
    return this.hasSideEffects(ast);
  }

  // æ–°å¢: è§£ææ¨¡å—
  resolveModule(modulePath) {
    // 1. è§£ææ¨¡å—çš„ç»å¯¹è·¯å¾„
    const absolutePath = this.resolveModulePath(modulePath);
    
    // 2. è¯»å–æ¨¡å—æ–‡ä»¶å†…å®¹
    const content = this.readFileContent(absolutePath);
    
    // 3. è¿”å›æ¨¡å—å¯¹è±¡
    return {
      id: absolutePath,
      content,
      path: absolutePath,
      isEntry: false
    };
  }

  // æ–°å¢: åˆ¤æ–­æ˜¯å¦æœ‰å‰¯ä½œç”¨
  hasSideEffects(ast) {
    // éå† AST æ£€æŸ¥èŠ‚ç‚¹ç±»å‹:
    // 1. AssignmentExpression (èµ‹å€¼è¡¨è¾¾å¼)
    // 2. CallExpression (å‡½æ•°è°ƒç”¨)
    // 3. NewExpression (new æ“ä½œç¬¦)
    // 4. UpdateExpression (æ›´æ–°è¡¨è¾¾å¼)
    return false;
  }

  // æ–°å¢: è§£ææ¨¡å—è·¯å¾„
  resolveModulePath(modulePath) {
    // 1. å¤„ç†ç›¸å¯¹è·¯å¾„
    // 2. å¤„ç†åˆ«åè·¯å¾„
    // 3. å¤„ç† node_modules
    // 4. æ·»åŠ æ–‡ä»¶æ‰©å±•å
    return 'resolved/path/to/module';
  }

  // æ–°å¢: è¯»å–æ–‡ä»¶å†…å®¹
  readFileContent(filePath) {
    // 1. è¯»å–æ–‡ä»¶
    // 2. å¤„ç†ç¼–ç 
    // 3. å¤„ç† BOM
    return 'file content';
  }
}
```












## å‚è€ƒæ–‡æ¡£


